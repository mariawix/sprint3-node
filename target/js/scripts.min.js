!function(a){"use strict";function b(a){var b,c,d={},e=Object.getOwnPropertyNames(a);for(b=0;b<e.length;b++)c=e[b],d[c]=a[c];return d}function c(a){var c,d=a.item,e=a.amount;C[d.id]?x(w()-j(d)*C[d.id].amount):(c=b(d),c.amount=e,C[d.id]=c),x(w()+j(d)*e),C[d.id].amount=e,h()}function d(a){var c,d=a.item;C[d.id]||(c=b(d),c.amount=0,C[d.id]=c),C[d.id].amount++,h()}function e(a){var b=a.item;C[b.id].amount=C[b.id].amount-1,h()}function f(){var a;for(a in C)y.publish(y.eventNames.resetItemAmount+a,{});C={},B=[],A=0,h()}function g(){var a,b=0;for(a in C)b+=j(C[a])*C[a].amount;b=b.toFixed(2),x(b)}function h(){var a,b=[];for(a in C)C[a].amount>0&&b.push(C[a]);o(b),q(),g()}function i(a){var b=a.discount+A;return b>100&&(b=100),b}function j(a){return+(a.price*(100-i(a))/100).toFixed(2)}function k(a){for(var b=0;b<B.length;b++)if(String(B[b].couponID)===String(a))return B[b]}function l(){var b;b=v(),k(b)||a.sendRequest("GET","/getCouponByID","couponID="+b,function(a){""!==a&&(B.push(a),a.discount?(A+=a.discount,A=A>100?100:A):d({item:a.freeItem})),h()})}function m(){G.addEventListener("click",function(a){a.preventDefault(),s()}),E.addEventListener("click",function(a){a.preventDefault(),f()}),F.addEventListener("click",function(a){a.preventDefault(),t(),h()}),D.addEventListener("click",function(a){a.preventDefault(),l()}),y.subscribe(y.eventNames.addItemToCart,d),y.subscribe(y.eventNames.removeItemFromCart,e),y.subscribe(y.eventNames.setItemAmountInCart,c)}function n(){view.loadTableHead(K,z,u),view.loadTableHead(L,N,u)}function o(a){var b=view.createRowElements(a,z,p);view.loadRows(K,b,0,a.length)}function p(a,b,c){switch(a){case"total":c.innerText=String((j(b)*b.amount).toFixed(2));break;case"discount":c.innerText=i(b);break;default:c.innerText=b[a]}}function q(){var a=view.createRowElements(B,N,r);view.loadRows(L,a,0,B.length)}function r(a,b,c){switch(a){case"code":c.innerText=b.couponID;break;default:b.freeItem?c.innerText="Free item ID: "+b.freeItem.id:c.innerText="Discount val: "+b.discount}}function s(){view.hideElements([G,J,I]),view.exposeElements([F])}function t(){view.exposeElements([J,G,I]),view.hideElements([F])}function u(){}function v(){var a=H.value;return H.value="",a}function w(){return parseInt(M.value,10)}function x(a){M.value=a}var y=a.eventBus,z=["id","name","price","amount","discount","total"],A=0,B=[],C={},D=document.querySelector(".coupon-submit-btn"),E=document.querySelector(".reset-cart-btn"),F=document.querySelector(".view-cart-btn"),G=document.querySelector(".hide-cart-btn"),H=document.querySelector(".coupon-input"),I=document.querySelector(".coupon-input-container"),J=document.querySelector(".cart-details"),K=document.querySelector(".cart-table"),L=document.querySelector(".coupon-table"),M=document.querySelector(".total-bill"),N=["code","details"];a.cart={init:function(){n(),m()}}}(app),function(a){"use strict";function b(a){o=view.createRowElements(a,n,g),view.loadTableHead(m,n,f),i()}function c(){var a;for(a=0;a<o.length;a++)o[a].dataset.index=a;return o}function d(a){o.sort(function(b,c){var d,e=view.getElementValueByClassName(b,a.key),f=view.getElementValueByClassName(c,a.key);return d=e>f?1:-1,a.asc?d:-d}),c(),l.publish(l.eventNames.reloadPagination,{})}function e(a,b){view.loadRows(m,o,a,b)}function f(a,b,c){var d,e,f;"image"!==b&&"cart"!==b&&(f=c?l.eventNames.sortAscBtnClicked:l.eventNames.sortDescBtnClicked,e=c?{innerHTML:"&uarr;",className:j}:{innerHTML:"&darr;",className:k},d=view.createCustomElement("span",e),d.onclick=function(){l.publish(f,{key:b,asc:c})},a.appendChild(d))}function g(a,b,c){switch(a){case"image":view.appendChild(c,"img",{src:b[a],alt:"image"});break;case"cart":quantityButtons.appendQuantityBtns(c,b);break;case"price":b.discount>0&&view.appendChild(c,"span",{innerText:b.price.toFixed(2),className:"old-price"}),view.appendChild(c,"span",{innerText:(b.price*(100-b.discount)/100).toFixed(2),className:"new-price"});break;default:c.innerText=b[a]}}function h(a){var b,c,d,f;d=view.getFirstBodyRow(m),f=parseInt(d.dataset.index,10),c=Math.floor(f/a)+1,b=(c-1)*a,e(b,b+a),l.publish(l.eventNames.curPageChanged,c)}function i(){l.subscribe(l.eventNames.pageBtnClicked,function(a){e(a.start,a.end)}),l.subscribe(l.eventNames.pagingSizeChanged,h),l.subscribe(l.eventNames.reloadItems,function(a){e(0,a)}),l.subscribe(l.eventNames.sortAscBtnClicked,d),l.subscribe(l.eventNames.sortDescBtnClicked,d)}var j="sort-asc-btn",k="sort-desc-btn",l=a.eventBus,m=document.querySelector(".catalog"),n=["id","name","description","image","price","cart"],o=[];a.catalog={init:b,loadRows:e}}(app),function(a){"use strict";function b(b){var d=a.catalog,e=a.pagination,f=a.cart;d.init(b),e.init(b.length),d.loadRows(0,e.getPagingSize()),f.init(),c()}function c(){var a=document.querySelector(".switch-theme-btn"),b=document.querySelector("body");a.onclick=function(a){a.preventDefault(),b.classList.contains("default-theme")?(b.classList.remove("default-theme"),b.classList.add("green-theme")):(b.classList.add("default-theme"),b.classList.remove("green-theme"))}}a.sendRequest=function(a,b,c,d){var e=new XMLHttpRequest;e.onreadystatechange=function(){var a="";4===e.readyState&&200===e.status&&(""!==e.responseText&&(a=JSON.parse(e.responseText)),d(a))},e.open(a,b+"?"+c,!0),e.send()},a.sendRequest("GET","/getItems","",b)}(app),function(a){"use strict";function b(a){c(),i(1,a),d(a)}function c(){m.subscribe(m.eventNames.curPageChanged,function(a){view.getElementByClassName(n,k).classList.remove(k),view.getElementByClassName(n,j+":nth-child("+a+")").classList.add(k)}),m.subscribe(m.eventNames.reloadPagination,function(){m.publish(m.eventNames.reloadItems,g())})}function d(a){o.onchange=function(){m.publish(m.eventNames.pagingSizeChanged,g()),i(f(),a)}}function e(a){a.onclick=function(){var b,c,d=JSON.parse(a.dataset.paging);b=view.getElementByClassName(a,l),c=parseInt(b.innerText,10),m.publish(m.eventNames.pageBtnClicked,{start:d.start,end:d.end}),m.publish(m.eventNames.curPageChanged,c)}}function f(){var a,b,c;return a=view.getElementByClassName(n,k),b=view.getElementByClassName(a,l),c=parseInt(b.innerText,10),isNaN(c)?1:c}function g(){return parseInt(o.value,10)}function h(a,b,c){var d,e,f,g=(b-1)*c,h=b*c;return e=j,a&&(e+=" "+k),d={className:e,dataset:{paging:'{"start": '+g+', "end": '+h+"}"}},f=view.createCustomElement("li",d),view.appendChild(f,"span",{className:l,innerText:b}),f}function i(a,b){var c,d,f,g=document.createDocumentFragment(),i=o.value<b?o.value:b;for(n.innerHTML="",f=0;f<n.childNodes.length;f++)n.childNodes[f].onclick=void 0;for(c=1;b>(c-1)*i;c++)d=h(c===a,c,i),g.appendChild(d),e(d);n.appendChild(g)}var j="page-btn",k="current-page-btn",l="page-link",m=a.eventBus,n=document.querySelector(".pagination-list"),o=document.querySelector(".paging-size");a.pagination={init:b,getPagingSize:g}}(app),function(a){"use strict";function b(a,b){e[a]=b}function c(a){e[a]=void 0}function d(a,b){e[a]&&e[a](b)}var e={};a.eventBus={subscribe:b,unsubscribe:c,publish:d,eventNames:{pagingSizeChanged:"pagingSizeChanged",pageBtnClicked:"pageBtnClicked",curPageChanged:"curPageChanged",reloadItems:"reloadItems",resetItemAmount:"resetItemAmount",setItemAmountInCart:"setItemCartAmount",addItemToCart:"addItemToCart",removeItemFromCart:"removeItemFromCart",sortAscBtnClicked:"sortAscBtnClicked",sortDescBtnClicked:"sortDescBtnClicked",reloadPagination:"reloadPagination"}}}(app),quantityButtons=function(){"use strict";function a(a){var b,c={className:g,innerText:"Add"};return b=view.createCustomElement("button",c),b.onclick=function(b){b.preventDefault();var c=parseInt(a.itemAmountElement.value,10);!isNaN(c)&&c<a.item.quantity&&(a.itemAmountElement.value=c+1,i.publish(i.eventNames.addItemToCart,a))},b}function b(a){var b,c={className:h,innerText:"Remove"};return b=view.createCustomElement("button",c),b.onclick=function(b){b.preventDefault();var c=parseInt(a.itemAmountElement.value,10);!isNaN(c)&&c>0&&(a.itemAmountElement.value=c-1,i.publish(i.eventNames.removeItemFromCart,a))},b}function c(a){var b,c={className:f,value:0};return 0===a.quantity&&(c.disabled="true"),b=view.createCustomElement("input",c),i.subscribe(i.eventNames.resetItemAmount+a.id,function(){b.value=0}),b.onchange=function(c){c.preventDefault();var d=parseInt(b.value,10);(isNaN(d)||0>d||d>a.quantity)&&(d=0),b.value=d,i.publish(i.eventNames.setItemAmountInCart,{item:a,amount:d})},b}function d(d,f){var g,h,i;h=view.appendChild(d,"span",{className:e}),g=c(f),h.appendChild(g),i={itemAmountElement:g,item:f},h.appendChild(a(i)),h.appendChild(b(i))}var e="item-amount",f="amount",g="add",h="remove",i=app.eventBus;return{appendQuantityBtns:d}}(),view=function(){"use strict";function a(a,b){var c,d,e=document.createElement(a);for(c in b)if("object"==typeof b[c])for(d in b[c])e[c][d]=b[c][d];else e[c]=b[c];return e}function b(b,c,d){var e;return e=a(c,d),b.appendChild(e),e}function c(a,b){return a.querySelector("."+b)}function d(d,e,f){function g(a){var c,d={innerText:a,className:l+" "+l+"-"+a};c=b(h,"div",d),f(c,a,!0),f(c,a,!1)}var h=a("div",{className:p}),i=c(d,n);e.forEach(function(a){g(a)}),i.appendChild(h),d.appendChild(i)}function e(a,b,d,e){var f,g=c(a,o);for(e=e<b.length?e:b.length,g.innerHTML="",f=d;e>f;f++)g.appendChild(b[f]);a.appendChild(g)}function f(a,b){var d,e=c(a,b).innerText;return d=parseInt(e,10),isNaN(d)?e:d}function g(a){var b=c(a,o);return c(b,p+":first-child")}function h(c,d,e){function f(c,f){var g=p+" "+p+"-"+c.type,h=a("div",{className:g,dataset:{index:f}});return d.forEach(function(a){var d=a+" "+m,f=b(h,"div",{className:d});e(a,c,f)}),h}var g,h=[];for(g=0;g<c.length;g++)h.push(f(c[g],g));return h}function i(a){a.forEach(function(a){a.classList.contains(k)&&a.classList.remove(k)})}function j(a){a.forEach(function(a){a.classList.contains(k)||a.classList.add(k)})}var k="visuallyhidden",l="th",m="td",n="thead",o="tbody",p="tr";return{appendChild:b,createCustomElement:a,getElementByClassName:c,getElementValueByClassName:f,loadTableHead:d,loadRows:e,getFirstBodyRow:g,createRowElements:h,hideElements:j,exposeElements:i}}(),function(){"use strict";function a(a,b,c){return a?(c.writeHead(404),void c.end(JSON.stringify(a))):(c.writeHead(200),void c.end(b))}function b(a){var b=a.length;return a.indexOf(".js",b-3)>0?"text/javascript":a.indexOf(".css",b-4)>0?"text/css":a.indexOf(".ico",b-4)>0?"image/x-icon":a.indexOf(".html",b-5)>0?"text/html":"text/plain"}function c(c,d){var e,g;"/"===c&&(c="/index.html"),e=f+c,g=b(c),h.readFile(e,function(b,c){d.setHeader("content-type",g+"; charset=utf-8"),a(b,c,d)})}var d=3e3,e="localhost",f="./client",g=require("http"),h=require("fs"),i=require("./db/db"),j=require("url"),k=require("querystring");i.init(),g.createServer(function(b,d){var e=j.parse(b.url),f=b.method,g=k.parse(e.query),h=e.pathname;switch(h){case"/getItems":"GET"===f&&a("",JSON.stringify(i.getItems()),d);break;case"/getCouponByID":"GET"===f&&a("",JSON.stringify(i.getCouponByID(g.couponID)),d);break;default:"GET"===f&&c(h,d)}}).listen(d,e)}(),module.exports=function(){"use strict";function a(){i=g(require(k+"/items.json")),j=h(require(k+"/coupons.json"),i.items)}function b(a){for(var b,c=0;c<j.couponsNum;c++)if(j.coupons[c].getID()===a)return b=j.coupons[c],b instanceof j.couponClasses.DiscountCoupon?{couponID:b.getID(),discount:b.getDiscountValue()}:{couponID:b.getID(),freeItem:b.getFreeItem()}}function c(){return i.items}function d(a){for(var b=0;b<i.itemsNum;b++)if(i.items[b].id===a)return i.items[b]}function e(a,b,c){return Math.floor(Math.random()*b+a)*c}function f(a){var b,c,d={},e=Object.getOwnPropertyNames(a);for(b=0;b<e.length;b++)c=e[b],d[c]=a[c];return d}function g(a){function b(a){var b,c={};for(b=0;b<h.length;b++)c[h[b]]={configurable:!1,enumerable:!0,writable:!1},c[h[b]].value=a[h[b]];c.quantity.writable=!0,Object.defineProperties(this,c)}function c(a){a.image="/img/sale-item.ico",a.type="sale",a.quantity=e(1,9,1),a.discount=e(1,7,10),b.call(this,a)}function d(a){a.image="/img/out-of-stock-item.ico",a.type="out",a.quantity=0,a.discount=0,b.call(this,a)}var f,g,h=["id","name","description","image","price","type","quantity","discount"],i=[],j=[b,c,d];return a.forEach(function(a){f=e(0,j.length,1),j[f]===b&&(a.image="/img/base-item.ico",a.type="base",a.quantity=e(1,5,1),a.discount=0),g=new j[f](a),i.push(g)}),{items:i,itemsNum:i.length}}function h(a,b){function c(a){var b=a;this.getID=function(){return b}}function d(a,b){c.call(this,b);var d=f(a);d.discount=100,this.getFreeItem=function(){return d}}function g(a,b){c.call(this,b);var d=a;this.getDiscountValue=function(){return d}}function h(){var a,b="";for(a=0;5>a;a++)b+=e(0,9,1);return b}var i,j,k,l=[];for(g.prototype=Object.create(c),g.prototype.constructor=g,d.prototype=Object.create(c),d.prototype.constructor=d,k=0;k<a.length;k++)j=h(),console.log(j),i=k%2===0?new g(e(1,7,10),j):new d(b[e(0,b.length,1)],j),l.push(i);return{couponsNum:l.length,couponClasses:{Coupon:c,DiscountCoupon:g,FreeItemCoupon:d},coupons:l}}var i,j,k="./data";return{init:a,getCouponByID:b,getItems:c,getItemByID:d}}();